const $={math:{url:"",sheetId:"",gid:"0",fallback:"/src/data/questions-math-grade3.json"},vietnamese:{url:"",sheetId:"",gid:"0",fallback:"/src/data/questions-vietnamese-grade3.json"},english:{url:"",sheetId:"",gid:"0",fallback:"/src/data/questions-english-mover.json"}},q=(e,o="0")=>e?`https://docs.google.com/spreadsheets/d/${e}/export?format=csv&gid=${o}`:null,x=new Set(["id","question","type","choices","answer","hint","points","explanation","explain","image_url","image","imageurl","level","level_id","subject","subject_id","quiz_type","group","tags","difficulty","estimated_time","time","creator","creator_id","creator_name","source","source_url","description","title"]),S=(e="")=>e.trim().toLowerCase(),C=e=>{const o=[];return Object.keys(e).forEach(t=>{const s=e[t];if(!s||!s.trim())return;const r=S(t);if(r.startsWith("choice")||r.startsWith("option")){o.push(s.trim());return}x.has(r)||o.push(s.trim())}),o},L=(e,o=!0)=>{const s=e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).filter(i=>i.trim());if(s.length===0)return console.warn("CSV is empty"),[];const r=o?v(s[0]).map(i=>i.trim().replace(/^"|"$/g,"").toLowerCase()):null;console.log("CSV Headers:",r);const n=[],a=o?1:0;for(let i=a;i<s.length;i++){const c=v(s[i]);if(!(c.length===0||c.every(l=>!l||!l.trim())))if(o&&r){const l={};r.forEach((m,h)=>{l[m]=(c[h]||"").trim()}),n.push(l)}else n.push(c)}return n},v=e=>{const o=[];let t="",s=!1;for(let r=0;r<e.length;r++){const n=e[r];n==='"'?s&&e[r+1]==='"'?(t+='"',r++):s=!s:n===","&&!s?(o.push(t.trim()),t=""):t+=n}return o.push(t.trim()),o},U=(e,o)=>{if(typeof e=="object"&&!Array.isArray(e)){const t=f=>{const y=S(f);return e[y]||e[f]||""},s=t("id")||`q${o+1}`,r=t("question")||"",n=(t("type")||"choice").toLowerCase(),a=t("answer")||"",i=t("hint")||"",c=parseInt(t("points"))||10,l=t("explanation")||t("explain")||"",h=(t("image_url")||t("image")||t("imageurl")||"").trim(),u=!h||h==="[URL]"||h.toLowerCase()==="url"?"":h;let g=C(e);if(g.length===0){const f=t("choices")||"";f&&f.trim()&&(g=f.replace(/^"|"$/g,"").split(",").map(d=>d.trim()).filter(d=>d))}return!r||!r.trim()?(console.warn(`Row ${o+1}: Missing question`,e),null):(n==="choice"&&g.length===0&&console.warn(`Row ${o+1}: Choice question without choices`,e),(!a||!a.trim())&&console.warn(`Row ${o+1}: Missing answer`,e),{id:s,question:r.trim(),type:n,choices:g.length>0?g:void 0,answer:a.trim(),hint:i.trim(),points:c,explanation:l.trim()||void 0,imageUrl:u||void 0})}if(Array.isArray(e)){const t=e[0]||`q${o+1}`,s=e[1]||"",r=(e[2]||"choice").toLowerCase();if(e[3]&&e[3].includes(",")){const u=e[3]?e[3].split(",").map(g=>g.trim()).filter(g=>g):[];return{id:t,question:s,type:r,choices:u.length>0?u:void 0,answer:e[4]||"",hint:e[5]||"",points:parseInt(e[6])||10,explanation:e[7]||void 0,imageUrl:e[8]||void 0}}const a=e[3]||"",i=e[4]||"",c=parseInt(e[5])||10,l=e[6]||"",m=e[7]||"",h=e.slice(8).map(u=>(u||"").trim()).filter(Boolean);return{id:t,question:s,type:r,choices:h.length>0?h:void 0,answer:a,hint:i,points:c,explanation:l.trim()||void 0,imageUrl:m.trim()||void 0}}return null},k=e=>{if(!e||e.includes("/export?format=csv")||e.includes("/gviz/tq?tqx=out:csv"))return e;const o=e.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);if(!o)return console.warn("Could not extract sheet ID from URL:",e),e;const t=o[1];let s="0";const r=e.match(/#gid=(\d+)/),n=e.match(/[?&]gid=(\d+)/);return r?s=r[1]:n&&(s=n[1]),`https://docs.google.com/spreadsheets/d/${t}/export?format=csv&gid=${s}`},w=async e=>{try{if(!e)throw new Error("Google Sheet URL is required");const o=k(e);console.log("Original URL:",e),console.log("Converted CSV URL:",o);let t,s;try{if(t=await fetch(o),!t.ok)throw new Error(`Failed to fetch Google Sheet: ${t.statusText}`);s=await t.text()}catch(a){console.warn("Direct fetch failed, trying proxy:",a);const i="https://eduquiz-api.eduquiz-api.workers.dev",c=`${i}/api/proxy/sheet?url=${encodeURIComponent(e)}`;if(t=await fetch(c),!t.ok){const l=await t.json().catch(()=>({error:t.statusText}));throw new Error(l.error||`Failed to fetch via proxy: ${t.statusText}`)}s=await t.text()}console.log("CSV Text (first 500 chars):",s.substring(0,500));const r=L(s,!0);console.log("Parsed rows count:",r.length),console.log("First few rows:",r.slice(0,3));const n=r.map((a,i)=>{try{return U(a,i)}catch(c){return console.error(`Error converting row ${i}:`,c,a),null}}).filter(a=>a&&a.question&&a.question.trim());return console.log("Converted questions count:",n.length),n.length>0&&console.log("Sample question:",n[0]),n}catch(o){throw console.error("Error fetching from Google Sheet CSV:",o),o}},R=async(e,o="0")=>{const t=q(e,o);if(!t)throw new Error("Sheet ID is required");return w(t)},p=async e=>{const o=$[e];if(!o)return console.warn(`No config found for subject: ${e}`),[];try{let t=[];if(o.url?(console.log(`Loading ${e} from Google Sheet URL...`),t=await w(o.url)):o.sheetId&&(console.log(`Loading ${e} from Google Sheet ID...`),t=await R(o.sheetId,o.gid)),t&&t.length>0)return console.log(`✅ Loaded ${t.length} questions from Google Sheet for ${e}`),t}catch(t){console.warn(`⚠️ Failed to load from Google Sheet for ${e}, using fallback:`,t)}try{if(o.fallback){console.log(`Loading ${e} from local JSON fallback...`);const t=await fetch(o.fallback);if(t.ok){const s=await t.json();return console.log(`✅ Loaded ${s.length} questions from local JSON for ${e}`),Array.isArray(s)?s:[]}}}catch(t){console.error(`❌ Failed to load fallback JSON for ${e}:`,t)}return[]},_=async()=>{const[e,o,t]=await Promise.all([p("math"),p("vietnamese"),p("english")]);return{math:e,vietnamese:o,english:t}};export{p as a,w as f,_ as l};
//# sourceMappingURL=googleSheetService-mjZez5jn.js.map
