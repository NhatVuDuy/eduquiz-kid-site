{"version":3,"file":"numberFormat-tpWeNAYq.js","sources":["../../src/services/quizStatsService.js","../../src/utils/numberFormat.js"],"sourcesContent":["/**\n * Quiz Stats Service\n * Tính toán thống kê cho Level → Subject → Quiz Type\n */\n\nimport { getAllCachedQuizzes, getAllQuizResults } from './storageService.js';\n\nconst STATS_CACHE_TTL = 5 * 1000; // 5 giây\nlet statsCache = null;\nlet cacheTimestamp = 0;\n\nconst ensureStatsData = async () => {\n  const now = Date.now();\n  if (statsCache && now - cacheTimestamp < STATS_CACHE_TTL) {\n    return statsCache;\n  }\n\n  const [quizzes, results] = await Promise.all([\n    getAllCachedQuizzes(),\n    getAllQuizResults(),\n  ]);\n\n  const resultIndex = new Map();\n  results.forEach(result => {\n    if (!result?.quizId) return;\n    if (!resultIndex.has(result.quizId)) {\n      resultIndex.set(result.quizId, []);\n    }\n    resultIndex.get(result.quizId).push(result);\n  });\n\n  statsCache = { quizzes, resultIndex };\n  cacheTimestamp = now;\n  return statsCache;\n};\n\nconst createAccumulator = () => ({\n  quizCount: 0,\n  totalUsage: 0,\n  playerIds: new Set(),\n  ratingTotal: 0,\n  ratingVotes: 0,\n});\n\nconst accumulateStats = (acc, quiz, quizResults = []) => {\n  acc.quizCount += 1;\n  acc.totalUsage += quiz?.usageCount || 0;\n\n  const rating = Number(quiz?.rating || 0);\n  const ratingCount = Number(quiz?.ratingCount || 0);\n\n  if (ratingCount > 0 && rating > 0) {\n    acc.ratingTotal += rating * ratingCount;\n    acc.ratingVotes += ratingCount;\n  } else if (rating > 0) {\n    acc.ratingTotal += rating;\n    acc.ratingVotes += 1;\n  }\n\n  quizResults.forEach(result => {\n    if (result?.playerId) {\n      acc.playerIds.add(result.playerId);\n    }\n  });\n};\n\nconst finalizeStats = (acc = createAccumulator()) => ({\n  quizCount: acc.quizCount,\n  totalUsage: acc.totalUsage,\n  playerCount: acc.playerIds.size,\n  averageRating:\n    acc.ratingVotes > 0\n      ? Number((acc.ratingTotal / acc.ratingVotes).toFixed(1))\n      : 0,\n});\n\nconst buildKey = (quiz, field) => {\n  return quiz?.[field] || quiz?.[field === 'quizType' ? 'group' : field === 'subjectId' ? 'subject' : field === 'levelId' ? 'level' : field];\n};\n\n/**\n * Lấy thống kê theo level\n * @returns {Promise<Record<string, Stats>>}\n */\nexport const getLevelStatsMap = async () => {\n  const { quizzes, resultIndex } = await ensureStatsData();\n  const statsByLevel = {};\n\n  quizzes.forEach(quiz => {\n    const levelId = buildKey(quiz, 'levelId');\n    if (!levelId) return;\n    if (!statsByLevel[levelId]) {\n      statsByLevel[levelId] = createAccumulator();\n    }\n    accumulateStats(statsByLevel[levelId], quiz, resultIndex.get(quiz.id));\n  });\n\n  return Object.keys(statsByLevel).reduce((acc, levelId) => {\n    acc[levelId] = finalizeStats(statsByLevel[levelId]);\n    return acc;\n  }, {});\n};\n\n/**\n * Lấy thống kê cho các môn của một level\n * @param {string} levelId\n * @returns {Promise<Record<string, Stats>>}\n */\nexport const getSubjectStatsMap = async (levelId) => {\n  const { quizzes, resultIndex } = await ensureStatsData();\n  const statsBySubject = {};\n\n  quizzes.forEach(quiz => {\n    const quizLevelId = buildKey(quiz, 'levelId');\n    if (levelId && quizLevelId !== levelId) return;\n\n    const subjectId = buildKey(quiz, 'subjectId');\n    if (!subjectId) return;\n\n    if (!statsBySubject[subjectId]) {\n      statsBySubject[subjectId] = createAccumulator();\n    }\n    accumulateStats(statsBySubject[subjectId], quiz, resultIndex.get(quiz.id));\n  });\n\n  return Object.keys(statsBySubject).reduce((acc, subjectId) => {\n    acc[subjectId] = finalizeStats(statsBySubject[subjectId]);\n    return acc;\n  }, {});\n};\n\n/**\n * Lấy thống kê theo loại quiz cho một level + subject\n * @param {string} levelId\n * @param {string} subjectId\n * @returns {Promise<Record<string, Stats>>}\n */\nexport const getQuizTypeStatsMap = async (levelId, subjectId) => {\n  const { quizzes, resultIndex } = await ensureStatsData();\n  const statsByType = {};\n\n  quizzes.forEach(quiz => {\n    const quizLevelId = buildKey(quiz, 'levelId');\n    const quizSubjectId = buildKey(quiz, 'subjectId');\n\n    if (levelId && quizLevelId !== levelId) return;\n    if (subjectId && quizSubjectId !== subjectId) return;\n\n    const quizType = buildKey(quiz, 'quizType');\n    if (!quizType) return;\n\n    if (!statsByType[quizType]) {\n      statsByType[quizType] = createAccumulator();\n    }\n    accumulateStats(statsByType[quizType], quiz, resultIndex.get(quiz.id));\n  });\n\n  return Object.keys(statsByType).reduce((acc, quizType) => {\n    acc[quizType] = finalizeStats(statsByType[quizType]);\n    return acc;\n  }, {});\n};\n\n/**\n * Force refresh stats cache (sau khi import quiz mới)\n */\nexport const invalidateQuizStatsCache = () => {\n  statsCache = null;\n  cacheTimestamp = 0;\n};\n\n\n","/**\n * Định dạng số hiển thị ngắn gọn (1.2k, 3.4M, ...)\n * @param {number} value\n * @returns {string}\n */\nexport const formatCompactNumber = (value) => {\n  const number = Number(value || 0);\n  if (!Number.isFinite(number) || number === 0) return '0';\n\n  if (number >= 1_000_000) {\n    return `${(number / 1_000_000).toFixed(1).replace(/\\.0$/, '')}M`;\n  }\n\n  if (number >= 1_000) {\n    return `${(number / 1_000).toFixed(1).replace(/\\.0$/, '')}k`;\n  }\n\n  return number.toString();\n};\n\n/**\n * Định dạng điểm rating (sao)\n * @param {number} value\n * @returns {string}\n */\nexport const formatRatingValue = (value) => {\n  const number = Number(value || 0);\n  if (!Number.isFinite(number) || number <= 0) {\n    return 'Chưa có';\n  }\n  return `${number.toFixed(1)}⭐`;\n};\n\n\n"],"names":["STATS_CACHE_TTL","statsCache","cacheTimestamp","ensureStatsData","now","quizzes","results","getAllCachedQuizzes","getAllQuizResults","resultIndex","result","createAccumulator","accumulateStats","acc","quiz","quizResults","rating","ratingCount","finalizeStats","buildKey","field","getLevelStatsMap","statsByLevel","levelId","getSubjectStatsMap","statsBySubject","quizLevelId","subjectId","getQuizTypeStatsMap","statsByType","quizSubjectId","quizType","formatCompactNumber","value","number","formatRatingValue"],"mappings":"+CAOA,MAAMA,EAAkB,EAAI,IAC5B,IAAIC,EAAa,KACbC,EAAiB,EAErB,MAAMC,EAAkB,SAAY,CAClC,MAAMC,EAAM,KAAK,IAAG,EACpB,GAAIH,GAAcG,EAAMF,EAAiBF,EACvC,OAAOC,EAGT,KAAM,CAACI,EAASC,CAAO,EAAI,MAAM,QAAQ,IAAI,CAC3CC,EAAmB,EACnBC,EAAiB,CACrB,CAAG,EAEKC,EAAc,IAAI,IACxB,OAAAH,EAAQ,QAAQI,GAAU,CACnBA,GAAQ,SACRD,EAAY,IAAIC,EAAO,MAAM,GAChCD,EAAY,IAAIC,EAAO,OAAQ,CAAA,CAAE,EAEnCD,EAAY,IAAIC,EAAO,MAAM,EAAE,KAAKA,CAAM,EAC5C,CAAC,EAEDT,EAAa,CAAE,QAAAI,EAAS,YAAAI,CAAW,EACnCP,EAAiBE,EACVH,CACT,EAEMU,EAAoB,KAAO,CAC/B,UAAW,EACX,WAAY,EACZ,UAAW,IAAI,IACf,YAAa,EACb,YAAa,CACf,GAEMC,EAAkB,CAACC,EAAKC,EAAMC,EAAc,CAAA,IAAO,CACvDF,EAAI,WAAa,EACjBA,EAAI,YAAcC,GAAM,YAAc,EAEtC,MAAME,EAAS,OAAOF,GAAM,QAAU,CAAC,EACjCG,EAAc,OAAOH,GAAM,aAAe,CAAC,EAE7CG,EAAc,GAAKD,EAAS,GAC9BH,EAAI,aAAeG,EAASC,EAC5BJ,EAAI,aAAeI,GACVD,EAAS,IAClBH,EAAI,aAAeG,EACnBH,EAAI,aAAe,GAGrBE,EAAY,QAAQL,GAAU,CACxBA,GAAQ,UACVG,EAAI,UAAU,IAAIH,EAAO,QAAQ,CAErC,CAAC,CACH,EAEMQ,EAAgB,CAACL,EAAMF,OAAyB,CACpD,UAAWE,EAAI,UACf,WAAYA,EAAI,WAChB,YAAaA,EAAI,UAAU,KAC3B,cACEA,EAAI,YAAc,EACd,QAAQA,EAAI,YAAcA,EAAI,aAAa,QAAQ,CAAC,CAAC,EACrD,CACR,GAEMM,EAAW,CAACL,EAAMM,IACfN,IAAOM,CAAK,GAAKN,IAAOM,IAAU,WAAa,QAAUA,IAAU,YAAc,UAAYA,IAAU,UAAY,QAAUA,CAAK,EAO9HC,EAAmB,SAAY,CAC1C,KAAM,CAAE,QAAAhB,EAAS,YAAAI,CAAW,EAAK,MAAMN,EAAe,EAChDmB,EAAe,CAAA,EAErB,OAAAjB,EAAQ,QAAQS,GAAQ,CACtB,MAAMS,EAAUJ,EAASL,EAAM,SAAS,EACnCS,IACAD,EAAaC,CAAO,IACvBD,EAAaC,CAAO,EAAIZ,EAAiB,GAE3CC,EAAgBU,EAAaC,CAAO,EAAGT,EAAML,EAAY,IAAIK,EAAK,EAAE,CAAC,EACvE,CAAC,EAEM,OAAO,KAAKQ,CAAY,EAAE,OAAO,CAACT,EAAKU,KAC5CV,EAAIU,CAAO,EAAIL,EAAcI,EAAaC,CAAO,CAAC,EAC3CV,GACN,CAAA,CAAE,CACP,EAOaW,EAAqB,MAAOD,GAAY,CACnD,KAAM,CAAE,QAAAlB,EAAS,YAAAI,CAAW,EAAK,MAAMN,EAAe,EAChDsB,EAAiB,CAAA,EAEvB,OAAApB,EAAQ,QAAQS,GAAQ,CACtB,MAAMY,EAAcP,EAASL,EAAM,SAAS,EAC5C,GAAIS,GAAWG,IAAgBH,EAAS,OAExC,MAAMI,EAAYR,EAASL,EAAM,WAAW,EACvCa,IAEAF,EAAeE,CAAS,IAC3BF,EAAeE,CAAS,EAAIhB,EAAiB,GAE/CC,EAAgBa,EAAeE,CAAS,EAAGb,EAAML,EAAY,IAAIK,EAAK,EAAE,CAAC,EAC3E,CAAC,EAEM,OAAO,KAAKW,CAAc,EAAE,OAAO,CAACZ,EAAKc,KAC9Cd,EAAIc,CAAS,EAAIT,EAAcO,EAAeE,CAAS,CAAC,EACjDd,GACN,CAAA,CAAE,CACP,EAQae,EAAsB,MAAOL,EAASI,IAAc,CAC/D,KAAM,CAAE,QAAAtB,EAAS,YAAAI,CAAW,EAAK,MAAMN,EAAe,EAChD0B,EAAc,CAAA,EAEpB,OAAAxB,EAAQ,QAAQS,GAAQ,CACtB,MAAMY,EAAcP,EAASL,EAAM,SAAS,EACtCgB,EAAgBX,EAASL,EAAM,WAAW,EAGhD,GADIS,GAAWG,IAAgBH,GAC3BI,GAAaG,IAAkBH,EAAW,OAE9C,MAAMI,EAAWZ,EAASL,EAAM,UAAU,EACrCiB,IAEAF,EAAYE,CAAQ,IACvBF,EAAYE,CAAQ,EAAIpB,EAAiB,GAE3CC,EAAgBiB,EAAYE,CAAQ,EAAGjB,EAAML,EAAY,IAAIK,EAAK,EAAE,CAAC,EACvE,CAAC,EAEM,OAAO,KAAKe,CAAW,EAAE,OAAO,CAAChB,EAAKkB,KAC3ClB,EAAIkB,CAAQ,EAAIb,EAAcW,EAAYE,CAAQ,CAAC,EAC5ClB,GACN,CAAA,CAAE,CACP,EC5JamB,EAAuBC,GAAU,CAC5C,MAAMC,EAAS,OAAOD,GAAS,CAAC,EAChC,MAAI,CAAC,OAAO,SAASC,CAAM,GAAKA,IAAW,EAAU,IAEjDA,GAAU,IACL,IAAIA,EAAS,KAAW,QAAQ,CAAC,EAAE,QAAQ,OAAQ,EAAE,CAAC,IAG3DA,GAAU,IACL,IAAIA,EAAS,KAAO,QAAQ,CAAC,EAAE,QAAQ,OAAQ,EAAE,CAAC,IAGpDA,EAAO,SAAQ,CACxB,EAOaC,EAAqBF,GAAU,CAC1C,MAAMC,EAAS,OAAOD,GAAS,CAAC,EAChC,MAAI,CAAC,OAAO,SAASC,CAAM,GAAKA,GAAU,EACjC,UAEF,GAAGA,EAAO,QAAQ,CAAC,CAAC,GAC7B"}