{"version":3,"mappings":"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","names":["importQuizFromGoogleSheet","sheetUrl","quizType","levelId","subjectId","userId","isPublic","questions","fetchFromGoogleSheetCSV","getLevelById","__vitePreload","getSubjectsForLevel","level","subjectName","s","levelName","quizId","isOfficial","QUIZ_GROUP_TYPES","isCommunity","isPersonal","metadata","createQuizMetadata","QUIZ_SOURCE_TYPES","normalizedQuestions","q","idx","cloudResult","cloudQuizzes","quizData","createQuizData","cacheQuiz","error","ImportQuizScreen","goToNext","useFlowStore","currentPlayer","usePlayerStore","setSheetUrl","useState","selectedLevel","setSelectedLevel","selectedSubject","setSelectedSubject","selectedQuizType","setSelectedQuizType","QUIZ_TYPES","setIsPublic","loading","setLoading","setError","success","setSuccess","levels","setLevels","subjects","setSubjects","user","getCurrentUser","canCreate","canCreateQuiz","useEffect","loadLevelsData","loadSubjectsData","loadedLevels","loadLevels","defaultLevel","l","loadedSubjects","loadSubjectsForLevel","quizTypes","handleImport","soundService","err","ScreenContainer","jsx","BackButton","Header","Card","jsxs","Input","e","OptionButton","subject","type","Button"],"ignoreList":[],"sources":["../../src/services/quizManagementService.js","../../src/screens/ImportQuizScreen.jsx"],"sourcesContent":["/**\n * Quiz Management Service\n * Service qu·∫£n l√Ω b√†i test theo 3 nh√≥m: official, community, personal\n */\n\nimport { QUIZ_GROUP_TYPES, QUIZ_SOURCE_TYPES, createQuizMetadata, createQuizData } from '../models/quiz.js';\nimport { fetchFromGoogleSheetCSV, fetchFromGoogleSheetById } from './googleSheetService.js';\nimport { cacheQuiz, getCachedQuiz, getAllCachedQuizzes } from './storageService.js';\nimport { cloudQuizzes } from './cloudService.js';\n\n/**\n * Load danh s√°ch b√†i test cho m·ªôt m√¥n h·ªçc trong nh√≥m\n * @param {string} group - Group type (official, community, personal)\n * @param {string} subjectId - Subject ID (math, vietnamese, english)\n * @param {string} userId - User ID (cho personal v√† community)\n * @returns {Promise<Array>} Array of quiz metadata\n */\nexport const loadQuizList = async (group, subjectId, userId = null) => {\n  try {\n    let quizzes = [];\n\n    if (group === QUIZ_GROUP_TYPES.OFFICIAL) {\n      // Try cloud first\n      try {\n        const cloudQuizzesResponse = await cloudQuizzes.getQuizzes({\n          subjectId,\n          quizType: QUIZ_GROUP_TYPES.OFFICIAL,\n          sortBy: 'created_at',\n        });\n        quizzes = Array.isArray(cloudQuizzesResponse)\n          ? cloudQuizzesResponse\n          : cloudQuizzesResponse?.results || [];\n\n        if (quizzes.length > 0) {\n          return quizzes.map((quiz) => ({\n            ...quiz,\n            subject: quiz.subject_id,\n            group: quiz.quiz_type,\n          }));\n        }\n      } catch (error) {\n        console.warn('loadQuizList: cloud fetch failed, fallback to cache', error);\n      }\n\n      // Fallback: cache\n      quizzes = await loadOfficialQuizzes(subjectId);\n    } else if (group === QUIZ_GROUP_TYPES.COMMUNITY) {\n      try {\n        const cloudQuizzesResponse = await cloudQuizzes.getQuizzes({\n          subjectId,\n          quizType: QUIZ_GROUP_TYPES.COMMUNITY,\n          sortBy: 'created_at',\n        });\n        quizzes = Array.isArray(cloudQuizzesResponse)\n          ? cloudQuizzesResponse\n          : cloudQuizzesResponse?.results || [];\n        if (quizzes.length > 0) {\n          return quizzes.map((quiz) => ({\n            ...quiz,\n            subject: quiz.subject_id,\n            group: quiz.quiz_type,\n          }));\n        }\n      } catch (error) {\n        console.warn('loadQuizList: cloud fetch failed (community), fallback to cache', error);\n      }\n      quizzes = await loadCommunityQuizzes(subjectId);\n    } else if (group === QUIZ_GROUP_TYPES.PERSONAL) {\n      try {\n        const cloudQuizzesResponse = await cloudQuizzes.getQuizzes({\n          subjectId,\n          quizType: QUIZ_GROUP_TYPES.PERSONAL,\n          creatorId: userId,\n          sortBy: 'created_at',\n        });\n        quizzes = Array.isArray(cloudQuizzesResponse)\n          ? cloudQuizzesResponse\n          : cloudQuizzesResponse?.results || [];\n        if (quizzes.length > 0) {\n          return quizzes.map((quiz) => ({\n            ...quiz,\n            subject: quiz.subject_id,\n            group: quiz.quiz_type,\n          }));\n        }\n      } catch (error) {\n        console.warn('loadQuizList: cloud fetch failed (personal), fallback to cache', error);\n      }\n      quizzes = await loadPersonalQuizzes(subjectId, userId);\n    }\n\n    return quizzes;\n  } catch (error) {\n    console.error(`Error loading quiz list for ${group}/${subjectId}:`, error);\n    return [];\n  }\n};\n\n/**\n * Load official quizzes (t·ª´ database ƒë√£ cache)\n */\nconst loadOfficialQuizzes = async (subjectId) => {\n  try {\n    // Load t·ª´ IndexedDB (ƒë√£ cache t·ª´ Google Sheets)\n    const cachedQuizzes = await getAllCachedQuizzes();\n    \n    return cachedQuizzes\n      .filter(quiz => \n        quiz.group === QUIZ_GROUP_TYPES.OFFICIAL && \n        quiz.subject === subjectId\n      )\n      .map(quiz => ({\n        ...quiz,\n        source: QUIZ_SOURCE_TYPES.DATABASE,\n      }));\n  } catch (error) {\n    console.error('Error loading official quizzes:', error);\n    return [];\n  }\n};\n\n/**\n * Load community quizzes (t·ª´ database)\n */\nconst loadCommunityQuizzes = async (subjectId) => {\n  try {\n    // TODO: Load t·ª´ cloud database (Cloudflare D1 ho·∫∑c t∆∞∆°ng t·ª±)\n    // Hi·ªán t·∫°i load t·ª´ IndexedDB local\n    const cachedQuizzes = await getAllCachedQuizzes();\n    \n    return cachedQuizzes\n      .filter(quiz => \n        quiz.group === QUIZ_GROUP_TYPES.COMMUNITY && \n        quiz.subject === subjectId &&\n        quiz.isPublic === true\n      )\n      .sort((a, b) => b.usageCount - a.usageCount) // Sort by popularity\n      .map(quiz => ({\n        ...quiz,\n        source: QUIZ_SOURCE_TYPES.DATABASE,\n      }));\n  } catch (error) {\n    console.error('Error loading community quizzes:', error);\n    return [];\n  }\n};\n\n/**\n * Load personal quizzes (c·ªßa ng∆∞·ªùi d√πng)\n */\nconst loadPersonalQuizzes = async (subjectId, userId) => {\n  try {\n    if (!userId) return [];\n    \n    // Load t·ª´ IndexedDB local\n    const cachedQuizzes = await getAllCachedQuizzes();\n    \n    return cachedQuizzes\n      .filter(quiz => \n        quiz.group === QUIZ_GROUP_TYPES.PERSONAL && \n        quiz.subject === subjectId &&\n        quiz.creatorId === userId\n      )\n      .sort((a, b) => b.createdAt - a.createdAt) // Sort by newest\n      .map(quiz => ({\n        ...quiz,\n        source: QUIZ_SOURCE_TYPES.DATABASE,\n      }));\n  } catch (error) {\n    console.error('Error loading personal quizzes:', error);\n    return [];\n  }\n};\n\n/**\n * Load b√†i test c·ª• th·ªÉ (bao g·ªìm c√¢u h·ªèi)\n * @param {string} quizId - Quiz ID\n * @param {string} group - Group type\n * @returns {Promise<Object>} Quiz data v·ªõi questions\n */\nexport const loadQuizData = async (quizId, group) => {\n  try {\n    // Th·ª≠ load t·ª´ cache tr∆∞·ªõc\n    const cached = await getCachedQuiz(quizId);\n    if (cached && cached.questions && cached.questions.length > 0) {\n      // Update usage count\n      await updateQuizUsageCount(quizId);\n      return cached;\n    }\n\n    // N·∫øu ch∆∞a c√≥ cache, load t·ª´ source\n    if (group === QUIZ_GROUP_TYPES.OFFICIAL) {\n      return await loadOfficialQuizData(quizId);\n    } else if (group === QUIZ_GROUP_TYPES.COMMUNITY) {\n      return await loadCommunityQuizData(quizId);\n    } else if (group === QUIZ_GROUP_TYPES.PERSONAL) {\n      return await loadPersonalQuizData(quizId);\n    }\n\n    return null;\n  } catch (error) {\n    console.error(`Error loading quiz data for ${quizId}:`, error);\n    throw error;\n  }\n};\n\n/**\n * Load official quiz data\n * - N·∫øu ƒë√£ cache: load t·ª´ database\n * - N·∫øu ch∆∞a: load t·ª´ Google Sheet ‚Üí cache v√†o database\n */\nconst loadOfficialQuizData = async (quizId) => {\n  // Th·ª≠ load t·ª´ cache\n  const cached = await getCachedQuiz(quizId);\n  if (cached && cached.questions && cached.questions.length > 0) {\n    return cached;\n  }\n\n  // Load t·ª´ Google Sheet (n·∫øu c√≥ sourceUrl)\n  // TODO: Load metadata t·ª´ database ƒë·ªÉ l·∫•y sourceUrl\n  // Hi·ªán t·∫°i: fallback v·ªÅ Google Sheets config\n  const { sheetsConfig } = await import('../config/sheets.config.js');\n  const config = sheetsConfig[quizId] || sheetsConfig.math; // Fallback\n  \n  if (config.url || config.sheetId) {\n    const questions = config.url\n      ? await fetchFromGoogleSheetCSV(config.url)\n      : await fetchFromGoogleSheetById(config.sheetId, config.gid);\n\n    const quizData = createQuizData({\n      metadata: createQuizMetadata({\n        id: quizId,\n        title: `B√†i test ${quizId}`,\n        description: '',\n        subject: quizId,\n        group: QUIZ_GROUP_TYPES.OFFICIAL,\n        source: QUIZ_SOURCE_TYPES.GOOGLE_SHEET,\n        sourceUrl: config.url || buildSheetUrl(config.sheetId, config.gid),\n        questionCount: questions.length,\n        isVerified: true,\n      }),\n      questions,\n      cachedAt: Date.now(),\n    });\n\n    // Cache v√†o database\n    await cacheQuiz(quizData);\n\n    return quizData;\n  }\n\n  return null;\n};\n\n/**\n * Load community quiz data\n */\nconst loadCommunityQuizData = async (quizId) => {\n  // Load t·ª´ database (ƒë√£ ƒë∆∞·ª£c ng∆∞·ªùi d√πng upload)\n  const cached = await getCachedQuiz(quizId);\n  if (cached) {\n    await updateQuizUsageCount(quizId);\n    return cached;\n  }\n\n  // N·∫øu ch∆∞a c√≥, c√≥ th·ªÉ load t·ª´ Google Sheet c·ªßa ng∆∞·ªùi t·∫°o\n  // TODO: Implement\n  return null;\n};\n\n/**\n * Load personal quiz data\n */\nconst loadPersonalQuizData = async (quizId) => {\n  // Load t·ª´ IndexedDB local\n  const cached = await getCachedQuiz(quizId);\n  if (cached) {\n    return cached;\n  }\n\n  // N·∫øu ch∆∞a c√≥, load t·ª´ Google Sheet c·ªßa ng∆∞·ªùi d√πng\n  // TODO: Implement\n  return null;\n};\n\n/**\n * Update usage count cho quiz\n */\nconst updateQuizUsageCount = async (quizId) => {\n  try {\n    const quiz = await getCachedQuiz(quizId);\n    if (quiz) {\n      quiz.usageCount = (quiz.usageCount || 0) + 1;\n      quiz.updatedAt = Date.now();\n      await cacheQuiz(quiz);\n    }\n  } catch (error) {\n    console.error('Error updating usage count:', error);\n  }\n};\n\n/**\n * Create new quiz (cho community ho·∫∑c personal)\n * @param {Object} quizData - Quiz data\n * @param {string} userId - User ID\n * @returns {Promise<Object>} Created quiz\n */\nexport const createQuiz = async (quizData, userId) => {\n  try {\n    const metadata = createQuizMetadata({\n      ...quizData,\n      id: `quiz_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      creatorId: userId,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    });\n\n    const fullQuizData = createQuizData({\n      metadata,\n      questions: quizData.questions || [],\n      cachedAt: Date.now(),\n    });\n\n    // Save to database\n    await cacheQuiz(fullQuizData);\n\n    return fullQuizData;\n  } catch (error) {\n    console.error('Error creating quiz:', error);\n    throw error;\n  }\n};\n\n/**\n * Import quiz t·ª´ Google Sheet (cho personal ho·∫∑c community)\n * @param {string} sheetUrl - Google Sheet URL\n * @param {string} quizType - Quiz type (official, community, personal)\n * @param {string} levelId - Level ID\n * @param {string} subjectId - Subject ID\n * @param {string} userId - User ID\n * @param {boolean} isPublic - C√≥ c√¥ng khai kh√¥ng (cho community)\n * @returns {Promise<Object>} Imported quiz\n */\nexport const importQuizFromGoogleSheet = async (sheetUrl, quizType, levelId, subjectId, userId, isPublic = false) => {\n  try {\n    // Load questions t·ª´ Google Sheet\n    const questions = await fetchFromGoogleSheetCSV(sheetUrl);\n\n    if (questions.length === 0) {\n      throw new Error('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong Google Sheet. Vui l√≤ng ki·ªÉm tra format.');\n    }\n\n    // Get level and subject info\n    const { getLevelById } = await import('../models/level.js').catch(() => ({ getLevelById: () => null }));\n    const { getSubjectsForLevel } = await import('../models/level.js').catch(() => ({ getSubjectsForLevel: () => [] }));\n    \n    const level = getLevelById ? getLevelById(levelId) : null;\n    const subjects = getSubjectsForLevel ? getSubjectsForLevel(levelId) : [];\n    const subject = subjects.find(s => s.id === subjectId);\n    const subjectName = subject?.name || subjectId;\n    const levelName = level?.name || levelId;\n\n    // Build metadata\n    const quizId = `quiz_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const isOfficial = quizType === QUIZ_GROUP_TYPES.OFFICIAL;\n    const isCommunity = quizType === QUIZ_GROUP_TYPES.COMMUNITY;\n    const isPersonal = quizType === QUIZ_GROUP_TYPES.PERSONAL;\n\n    const metadata = createQuizMetadata({\n      id: quizId,\n      title: `B√†i test ${subjectName}`,\n      description: `${levelName} - ${subjectName} - ƒê∆∞·ª£c import t·ª´ Google Sheet`,\n      levelId,\n      subjectId,\n      quizType,\n      source: QUIZ_SOURCE_TYPES.GOOGLE_SHEET,\n      sourceUrl: sheetUrl,\n      questionCount: questions.length,\n      // Gi·ªØ creatorId/creatorName cho local metadata (kh√¥ng ƒë·∫©y l√™n D1 ƒë·ªÉ tr√°nh FK l·ªói)\n      creatorId: userId,\n      creatorName: userId, // TODO: map sang b·∫£ng users sau n√†y\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      isPublic: isOfficial || isCommunity ? true : Boolean(isPublic && isCommunity),\n      isVerified: isOfficial,\n    });\n\n    // Chu·∫©n h√≥a c√¢u h·ªèi (ƒë·∫£m b·∫£o c√≥ id duy nh·∫•t theo quiz, order)\n    const normalizedQuestions = questions.map((q, idx) => ({\n      ...q,\n      // Lu√¥n d√πng id n·ªôi b·ªô theo quiz ƒë·ªÉ tr√°nh tr√πng v·ªõi id t·ª´ sheet/quiz kh√°c\n      id: `${quizId}_q${idx + 1}`,\n      originalId: q.id, // gi·ªØ id g·ªëc n·∫øu c·∫ßn d√πng sau n√†y (ch·ªâ ·ªü local)\n      order: q.order || idx + 1,\n    }));\n\n    // Push l√™n Cloudflare D1 (b·∫Øt bu·ªôc th√†nh c√¥ng; n·∫øu fail => throw)\n    const cloudResult = await cloudQuizzes.createQuiz({\n      id: metadata.id,\n      title: metadata.title,\n      description: metadata.description,\n      level_id: metadata.levelId,\n      subject_id: metadata.subjectId,\n      quiz_type: metadata.quizType,\n      source_type: metadata.source || 'google_sheet',\n      source_url: metadata.sourceUrl,\n      question_count: metadata.questionCount,\n      // T·∫°m th·ªùi KH√îNG set creator_id/creator_name l√™n D1 ƒë·ªÉ tr√°nh l·ªói FK (users table ch∆∞a c√≥ user n√†y)\n      // creator_id: metadata.creatorId,\n      // creator_name: metadata.creatorName,\n      is_public: metadata.isPublic,\n      is_verified: metadata.isVerified,\n      difficulty: metadata.difficulty || 'medium',\n      estimated_time: metadata.estimatedTime || metadata.questionCount,\n      tags: metadata.tags || [],\n      questions: normalizedQuestions.map((q) => ({\n        id: q.id,\n        question: q.question,\n        type: q.type,\n        choices: q.choices,\n        answer: q.answer,\n        hint: q.hint,\n        points: q.points,\n        explanation: q.explanation,\n        image_url: q.imageUrl,\n        question_order: q.order,\n      })),\n    });\n\n    if (!cloudResult || cloudResult.error) {\n      throw new Error(cloudResult?.error || 'Upload l√™n cloud th·∫•t b·∫°i');\n    }\n\n    const quizData = createQuizData({\n      metadata,\n      questions: normalizedQuestions,\n      cachedAt: Date.now(),\n    });\n\n    // Cache local (offline)\n    await cacheQuiz(quizData);\n\n    return quizData;\n  } catch (error) {\n    console.error('Error importing quiz from Google Sheet:', error);\n    throw error;\n  }\n};\n\n/**\n * Helper function ƒë·ªÉ build sheet URL\n */\nconst buildSheetUrl = (sheetId, gid) => {\n  return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;\n};\n\n","import React, { useState, useEffect } from 'react';\nimport { useFlowStore } from '../store/flowStore';\nimport { usePlayerStore } from '../store/playerStore';\nimport { useLevelStore } from '../store/levelStore';\nimport { importQuizFromGoogleSheet } from '../services/quizManagementService.js';\nimport { loadLevels, loadSubjectsForLevel } from '../services/levelService.js';\nimport { QUIZ_TYPES } from '../models/level.js';\nimport { soundService } from '../services/soundService';\nimport { canCreateQuiz, getCurrentUser } from '../services/userService.js';\nimport { Card } from '../components/Card';\nimport { Button } from '../components/Button';\nimport { Input } from '../components/Input';\nimport { ScreenContainer, Header, BackButton, OptionButton } from '../components/screen';\n\n/**\n * ImportQuizScreen Component\n * M√†n h√¨nh import b√†i test t·ª´ Google Sheet\n */\nexport const ImportQuizScreen = () => {\n  const { goToNext } = useFlowStore();\n  const { currentPlayer } = usePlayerStore();\n  \n  const [sheetUrl, setSheetUrl] = useState('');\n  const [selectedLevel, setSelectedLevel] = useState(null);\n  const [selectedSubject, setSelectedSubject] = useState(null);\n  const [selectedQuizType, setSelectedQuizType] = useState(QUIZ_TYPES.PERSONAL);\n  const [isPublic, setIsPublic] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n  const [success, setSuccess] = useState(false);\n  const [levels, setLevels] = useState([]);\n  const [subjects, setSubjects] = useState([]);\n\n  const user = getCurrentUser(currentPlayer);\n  const canCreate = canCreateQuiz(user);\n\n  useEffect(() => {\n    loadLevelsData();\n  }, []);\n\n  useEffect(() => {\n    if (selectedLevel) {\n      loadSubjectsData();\n    }\n  }, [selectedLevel]);\n\n  const loadLevelsData = async () => {\n    try {\n      const loadedLevels = await loadLevels();\n      setLevels(loadedLevels);\n      // Default to grade3\n      const defaultLevel = loadedLevels.find(l => l.id === 'grade3') || loadedLevels[0];\n      if (defaultLevel) {\n        setSelectedLevel(defaultLevel);\n      }\n    } catch (error) {\n      console.error('Error loading levels:', error);\n    }\n  };\n\n  const loadSubjectsData = async () => {\n    try {\n      const loadedSubjects = await loadSubjectsForLevel(selectedLevel.id);\n      setSubjects(loadedSubjects);\n      if (loadedSubjects.length > 0) {\n        setSelectedSubject(loadedSubjects[0]);\n      }\n    } catch (error) {\n      console.error('Error loading subjects:', error);\n    }\n  };\n\n  const quizTypes = [\n    {\n      id: QUIZ_TYPES.PERSONAL,\n      name: 'C√° nh√¢n',\n      description: 'Ch·ªâ b·∫°n m·ªõi th·∫•y',\n      icon: 'üë§',\n    },\n    {\n      id: QUIZ_TYPES.COMMUNITY,\n      name: 'C·ªông ƒë·ªìng',\n      description: 'Chia s·∫ª v·ªõi m·ªçi ng∆∞·ªùi',\n      icon: 'üë•',\n    },\n  ];\n\n  const handleImport = async () => {\n    if (!sheetUrl.trim()) {\n      setError('Vui l√≤ng nh·∫≠p URL Google Sheet');\n      return;\n    }\n\n    if (!selectedLevel || !selectedSubject) {\n      setError('Vui l√≤ng ch·ªçn c·∫•p ƒë·ªô v√† m√¥n h·ªçc');\n      return;\n    }\n\n    if (!canCreate) {\n      setError('B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o b√†i test');\n      return;\n    }\n\n    try {\n      setLoading(true);\n      setError(null);\n      setSuccess(false);\n\n      const quizData = await importQuizFromGoogleSheet(\n        sheetUrl.trim(),\n        selectedQuizType,\n        selectedLevel.id,\n        selectedSubject.id,\n        currentPlayer.id,\n        isPublic\n      );\n\n      setSuccess(true);\n      soundService.playSuccess();\n\n      // Reset form sau 2 gi√¢y\n      setTimeout(() => {\n        setSheetUrl('');\n        setSelectedLevel(levels.find(l => l.id === 'grade3') || levels[0]);\n        setSelectedSubject(null);\n        setIsPublic(false);\n        setSuccess(false);\n      }, 2000);\n    } catch (err) {\n      console.error('Error importing quiz:', err);\n      setError(err.message || 'C√≥ l·ªói khi import b√†i test. Vui l√≤ng ki·ªÉm tra l·∫°i URL.');\n      soundService.playError();\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  if (!canCreate) {\n    return (\n      <ScreenContainer>\n        <Header\n          title=\"T·∫°o b√†i test\"\n          subtitle=\"B·∫°n c·∫ßn quy·ªÅn ƒë·ªÉ t·∫°o b√†i test\"\n        />\n        <Card className=\"text-center py-8\">\n          <div className=\"text-6xl mb-4\">üîí</div>\n          <p className=\"text-xl text-gray-600 mb-4\">\n            B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o b√†i test\n          </p>\n          <p className=\"text-sm text-gray-500 mb-6\">\n            Ch·ªâ ph·ª• huynh v√† gi√°o vi√™n m·ªõi c√≥ th·ªÉ t·∫°o b√†i test\n          </p>\n          <BackButton onClick={() => goToNext('home')} />\n        </Card>\n      </ScreenContainer>\n    );\n  }\n\n  return (\n    <ScreenContainer>\n      <BackButton\n        inline\n        variant=\"ghost\"\n        label=\"‚Üê Quay l·∫°i\"\n        onClick={() => goToNext('home')}\n        className=\"mb-2\"\n      />\n      <Header\n        title=\"T·∫°o b√†i test t·ª´ Google Sheet\"\n        subtitle=\"Import c√¢u h·ªèi t·ª´ Google Spreadsheet\"\n      />\n\n      {error && (\n        <Card className=\"mb-4 p-4 bg-red-50 border border-red-200\">\n          <p className=\"text-red-800 text-sm\">‚ö†Ô∏è {error}</p>\n        </Card>\n      )}\n\n      {success && (\n        <Card className=\"mb-4 p-4 bg-green-50 border border-green-200\">\n          <p className=\"text-green-800 text-sm\">‚úÖ Import th√†nh c√¥ng! B√†i test ƒë√£ ƒë∆∞·ª£c l∆∞u.</p>\n        </Card>\n      )}\n\n      <div className=\"space-y-6\">\n        {/* Google Sheet URL */}\n        <Card>\n          <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n            URL Google Sheet *\n          </label>\n          <Input\n            type=\"url\"\n            value={sheetUrl}\n            onChange={(e) => setSheetUrl(e.target.value)}\n            placeholder=\"https://docs.google.com/spreadsheets/d/...\"\n            className=\"w-full\"\n            disabled={loading}\n          />\n          <p className=\"text-xs text-gray-500 mt-2\">\n            üìù L∆∞u √Ω: Sheet ph·∫£i ƒë∆∞·ª£c publish to web (CSV format)\n          </p>\n        </Card>\n\n        {/* Ch·ªçn c·∫•p ƒë·ªô */}\n        <Card>\n          <label className=\"block text-sm font-semibold text-gray-700 mb-3\">\n            Ch·ªçn c·∫•p ƒë·ªô *\n          </label>\n          <div className=\"grid grid-cols-3 gap-2 max-h-48 overflow-y-auto\">\n            {levels.map((level) => (\n              <OptionButton\n                key={level.id}\n                label={level.name}\n                description={level.description}\n                icon={level.icon}\n                selected={selectedLevel?.id === level.id}\n                onClick={() => setSelectedLevel(level)}\n                disabled={loading}\n                size=\"sm\"\n              />\n            ))}\n          </div>\n        </Card>\n\n        {/* Ch·ªçn m√¥n h·ªçc */}\n        {selectedLevel && (\n          <Card>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-3\">\n              Ch·ªçn m√¥n h·ªçc *\n            </label>\n            <div className=\"grid grid-cols-2 gap-3\">\n              {subjects.map((subject) => (\n                <OptionButton\n                  key={subject.id}\n                  label={subject.name}\n                  description={subject.description}\n                  icon={subject.icon}\n                  selected={selectedSubject?.id === subject.id}\n                  onClick={() => setSelectedSubject(subject)}\n                  disabled={loading}\n                />\n              ))}\n            </div>\n          </Card>\n        )}\n\n        {/* Ch·ªçn lo·∫°i */}\n        <Card>\n          <label className=\"block text-sm font-semibold text-gray-700 mb-3\">\n            Ch·ªçn lo·∫°i b√†i test\n          </label>\n          <div className=\"grid grid-cols-2 gap-3\">\n            {quizTypes.map((type) => (\n              <OptionButton\n                key={type.id}\n                label={type.name}\n                description={type.description}\n                icon={type.icon}\n                selected={selectedQuizType === type.id}\n                onClick={() => setSelectedQuizType(type.id)}\n                disabled={loading}\n              />\n            ))}\n          </div>\n        </Card>\n\n        {/* Public option (ch·ªâ cho community) */}\n        {selectedQuizType === QUIZ_TYPES.COMMUNITY && (\n          <Card>\n            <label className=\"flex items-center space-x-3 cursor-pointer\">\n              <input\n                type=\"checkbox\"\n                checked={isPublic}\n                onChange={(e) => setIsPublic(e.target.checked)}\n                disabled={loading}\n                className=\"w-5 h-5 text-primary-600 rounded focus:ring-primary-500\"\n              />\n              <div>\n                <span className=\"text-sm font-semibold text-gray-700\">\n                  Chia s·∫ª c√¥ng khai\n                </span>\n                <p className=\"text-xs text-gray-500\">\n                  B√†i test s·∫Ω hi·ªÉn th·ªã trong nh√≥m C·ªông ƒë·ªìng cho m·ªçi ng∆∞·ªùi\n                </p>\n              </div>\n            </label>\n          </Card>\n        )}\n\n        {/* Action buttons */}\n        <div className=\"flex gap-4\">\n          <Button\n            onClick={handleImport}\n            variant=\"primary\"\n            size=\"lg\"\n            disabled={loading || !sheetUrl.trim() || !selectedLevel || !selectedSubject}\n            className=\"flex-1\"\n          >\n            {loading ? '‚è≥ ƒêang import...' : 'üì• Import b√†i test'}\n          </Button>\n          <Button\n            onClick={() => goToNext('home')}\n            variant=\"outline\"\n            size=\"lg\"\n            disabled={loading}\n          >\n            H·ªßy\n          </Button>\n        </div>\n      </div>\n\n      {/* H∆∞·ªõng d·∫´n */}\n      <Card className=\"mt-6 bg-blue-50 border-blue-200\">\n        <h3 className=\"text-sm font-semibold text-blue-900 mb-2\">\n          üìñ H∆∞·ªõng d·∫´n:\n        </h3>\n        <ol className=\"text-xs text-blue-800 space-y-1 list-decimal list-inside\">\n          <li>T·∫°o Google Sheet v·ªõi format: id, question, type, choices, answer, hint, points</li>\n          <li>File ‚Üí Share ‚Üí Publish to web ‚Üí Ch·ªçn CSV format</li>\n          <li>Copy link v√† paste v√†o √¥ tr√™n</li>\n          <li>Ch·ªçn nh√≥m v√† m√¥n h·ªçc, sau ƒë√≥ click Import</li>\n        </ol>\n      </Card>\n\n      <BackButton onClick={() => goToNext('home')} />\n    </ScreenContainer>\n  );\n};\n\n"],"file":"ImportQuizScreen-CIxAvpo7.js"}