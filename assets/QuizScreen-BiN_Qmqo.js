import{j as e,u as F,s as E}from"./index--ILSzZaw.js";import{m as Q,r as m,A as B}from"./animation-vendor-B6fZrcjP.js";import{c as N,f as K,B as I,s as T}from"./Button-Bl6cuHxx.js";import{u as P}from"./quizStore-Chk_mg7S.js";import{c as W}from"./scoringService-jD34FX5V.js";import{S as R}from"./ScreenContainer-21a-fcYA.js";import"./react-vendor-labSKdyf.js";import"./ui-vendor-B8QmJS74.js";const X=({value:i=0,max:t=100,className:s="",showLabel:r=!0,color:d="primary",...h})=>{const f=Math.min(Math.max(i/t*100,0),100),a={primary:"bg-primary-600",secondary:"bg-secondary-600",success:"bg-green-600",warning:"bg-yellow-600",danger:"bg-red-600"};return e.jsxs("div",{className:N("w-full",s),...h,children:[r&&e.jsxs("div",{className:"flex justify-between mb-2 text-sm text-gray-600",children:[e.jsx("span",{children:"Tiáº¿n Ä‘á»™"}),e.jsxs("span",{children:[Math.round(f),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 overflow-hidden",children:e.jsx(Q.div,{className:N("h-full rounded-full",a[d]),initial:{width:0},animate:{width:`${f}%`},transition:{duration:.5,ease:"easeOut"}})})]})},H=({currentIndex:i,totalQuestions:t,timeRemaining:s,timeLimit:r,className:d="",...h})=>{const f=(i+1)/t*100;return e.jsxs("div",{className:N("mb-6",d),...h,children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("span",{className:"text-lg font-semibold text-gray-700",children:["CÃ¢u ",i+1," / ",t]}),r>0&&e.jsxs("span",{className:"text-lg font-semibold text-primary-600",children:["â±ï¸ ",K(s*1e3)]})]}),e.jsx(X,{value:f,color:"primary"})]})},U=i=>{if(!i||typeof i!="string")return null;const t=i.trim();let s=t.match(/drive\.usercontent\.google\.com\/download\?id=([a-zA-Z0-9_-]+)/);return s||(s=t.match(/\/file\/d\/([a-zA-Z0-9_-]+)/),s)||(s=t.match(/[?&]id=([a-zA-Z0-9_-]+)/),s)||(s=t.match(/\/open\?id=([a-zA-Z0-9_-]+)/),s)||(s=t.match(/\/uc\?id=([a-zA-Z0-9_-]+)/),s)?s[1]:(s=t.match(/\/drive\/folders\/([a-zA-Z0-9_-]+)/),s&&console.warn("Google Drive folder link detected. Folder links cannot be converted to direct image URLs. Please use individual file links."),null)},O=i=>{if(!i||typeof i!="string")return i;const t=i.trim();if(!t)return i;if(t.startsWith("http://")||t.startsWith("https://")){if(!(t.includes("drive.google.com")||t.includes("drive.usercontent.google.com"))||t.includes("/uc?export=view&id=")||t.includes("/uc?id="))return t;if(t.includes("drive.usercontent.google.com")&&t.includes("export=view")){const h=U(t);if(h)return`https://drive.google.com/uc?export=view&id=${h}`}}const s=U(t);if(!s)return t;const r=`https://drive.google.com/uc?export=view&id=${s}`;return typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.log("Converting Google Drive URL:",{original:t,fileId:s,converted:r,note:"If image fails to load, ensure the file is shared publicly (Anyone with the link)"}),r},_=(i,t="w1000")=>`https://drive.google.com/thumbnail?id=${i}&sz=${t}`,J=({question:i,questionNumber:t,imageUrl:s,hint:r,explanation:d,showExplanation:h=!1,children:f,className:a="",...x})=>{const[u,g]=m.useState(!1),[C,L]=m.useState(null),[S,w]=m.useState(new Set);return m.useEffect(()=>{if(s){const p=O(s);L(p),w(new Set([p])),g(!1)}},[s]),e.jsx(Q.div,{initial:{opacity:0,x:100},animate:{opacity:1,x:0},exit:{opacity:0,x:-100},transition:{duration:.3},...x,children:e.jsxs("div",{className:N("bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-100","backdrop-blur-sm bg-white/95",a),children:[e.jsxs("div",{className:"flex flex-col gap-3 mb-4",children:[typeof t=="number"&&e.jsxs("div",{className:"text-sm font-semibold text-primary-600 uppercase tracking-wide",children:["CÃ¢u ",t]}),s&&e.jsx("div",{className:"w-full h-48 md:h-56 rounded-2xl border border-gray-200 bg-gray-50 flex items-center justify-center overflow-hidden shadow-sm",children:u?e.jsxs("div",{className:"text-center p-4 text-gray-500",children:[e.jsx("p",{className:"text-sm mb-2",children:"âš ï¸ KhÃ´ng thá»ƒ táº£i áº£nh"}),e.jsx("p",{className:"text-xs",children:"File Google Drive cáº§n Ä‘Æ°á»£c share cÃ´ng khai (Anyone with the link)"}),e.jsx("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-primary-600 underline mt-2 inline-block",children:"Má»Ÿ áº£nh trong tab má»›i"})]}):e.jsx("img",{src:C,alt:`Question illustration ${t||""}`,className:"max-h-full max-w-full object-contain",loading:"lazy",onError:p=>{const y=s;console.error("Failed to load image:",{original:y,converted:C,attempted:Array.from(S)});let l=null;const q=[/\/file\/d\/([a-zA-Z0-9_-]+)/,/[?&]id=([a-zA-Z0-9_-]+)/,/drive\.usercontent\.google\.com\/download\?id=([a-zA-Z0-9_-]+)/];for(const n of q){const A=y.match(n);if(A){l=A[1];break}}if(!l){console.warn("Cannot extract file ID from URL:",y),g(!0);return}const o=[{name:"thumbnail",url:_(l,"w1000")},{name:"thumbnail-large",url:_(l,"w2000")},{name:"download",url:`https://drive.google.com/uc?export=download&id=${l}`},{name:"open",url:`https://drive.google.com/open?id=${l}`}].find(n=>!S.has(n.url));o?(console.log(`Trying alternative format (${o.name}):`,o.url),w(n=>new Set([...n,o.url])),L(o.url)):(console.warn("All image formats failed for file ID:",l),g(!0))},onLoad:()=>{console.log("Image loaded successfully:",C)}})}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-700 bg-clip-text text-transparent",children:i})]}),r&&e.jsx("div",{className:"bg-primary-50/50 border-l-4 border-primary-500 rounded-r-lg p-3 mb-4",children:e.jsxs("p",{className:"text-sm text-gray-700 font-medium",children:["ðŸ’¡ ",e.jsx("span",{className:"font-semibold",children:"Gá»£i Ã½:"})," ",r]})}),f,h&&d&&e.jsxs("div",{className:"mt-6 bg-amber-50 border border-amber-200 rounded-2xl p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-amber-800 mb-2",children:"Giáº£i thÃ­ch"}),e.jsx("p",{className:"text-sm text-amber-900 leading-relaxed",children:d})]})]})})},V=({choice:i,isSelected:t=!1,isCorrect:s=!1,isAnswered:r=!1,onClick:d,className:h="",...f})=>{const a=r;let x="w-full p-4 rounded-xl border-2 text-left transition-all duration-300 shadow-sm";return a?s?x+=" border-green-500 bg-gradient-to-r from-green-50 to-green-100 shadow-md shadow-green-200/50":t&&!s?x+=" border-red-500 bg-gradient-to-r from-red-50 to-red-100 shadow-md shadow-red-200/50":x+=" border-gray-300 bg-gray-50":x+=t?" border-primary-600 bg-gradient-to-r from-primary-50 to-primary-100 shadow-md shadow-primary-200/50":" border-gray-300 bg-white hover:border-primary-400 hover:bg-primary-50/50 hover:shadow-md",e.jsx(Q.button,{onClick:d,className:N(x,h),disabled:r,whileHover:r?{}:{scale:1.02},whileTap:r?{}:{scale:.98},animate:a&&s?{scale:[1,1.1,1],rotate:[0,5,-5,0]}:a&&t&&!s?{x:[0,-10,10,-10,10,0]}:{},...f,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg font-medium text-gray-800",children:i}),a&&s&&e.jsx("span",{className:"text-2xl",children:"âœ…"}),a&&t&&!s&&e.jsx("span",{className:"text-2xl",children:"âŒ"})]})})},Y=({value:i,onChange:t,onConfirm:s,isAnswered:r=!1,isCorrect:d=!1,correctAnswer:h="",disabled:f=!1,className:a="",...x})=>e.jsxs("div",{className:N("space-y-4",a),...x,children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:i,onChange:u=>!r&&t(u.target.value),onKeyPress:u=>{u.key==="Enter"&&i&&!r&&s()},className:N("w-full px-4 py-3 border-2 rounded-lg text-lg focus:outline-none transition-all",r?d?"border-green-500 bg-green-50":"border-red-500 bg-red-50":"border-gray-300 focus:border-primary-500"),placeholder:"Nháº­p cÃ¢u tráº£ lá»i...",disabled:r||f}),r&&e.jsx(Q.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:"absolute right-3 top-1/2 -translate-y-1/2 text-2xl",children:d?e.jsx("span",{className:"text-green-600",children:"âœ…"}):e.jsx("span",{className:"text-red-600",children:"âŒ"})})]}),r&&e.jsxs(Q.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:N("p-4 rounded-lg",d?"bg-green-50 border-2 border-green-200":"bg-red-50 border-2 border-red-200"),children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("span",{className:"text-lg font-semibold",children:d?"ÄÃºng rá»“i! ðŸŽ‰":"Sai rá»“i! ðŸ˜”"})}),!d&&h&&e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsx("span",{className:"font-medium",children:"ÄÃ¡p Ã¡n Ä‘Ãºng:"})," ",e.jsx("span",{className:"font-semibold text-green-700",children:h})]})]}),!r&&e.jsx(I,{onClick:s,variant:"primary",size:"lg",className:"w-full",disabled:!i||f,children:"XÃ¡c nháº­n"})]}),le=()=>{console.log("QuizScreen component rendered!");const{goToNext:i}=F(),{currentLesson:t,questionCount:s,quizSettings:r,setQuizResult:d,setQuestionCount:h,setQuizSettings:f}=P(),[a,x]=m.useState(0),[u,g]=m.useState(""),[C,L]=m.useState([]),[S,w]=m.useState(r?.timeLimit||0),[p,y]=m.useState(!1),l=m.useRef(null),q=m.useRef(!1);m.useEffect(()=>{if(!s&&t?.questions){const c=Math.min(10,t.questions.length);h(c),console.log("Setting default questionCount:",c)}},[s,t,h]);const j=t?.questions||[],o=m.useMemo(()=>{if(console.log("Shuffling questions:",{questionsLength:j.length,questionCount:s,hasCurrentLesson:!!t}),!j||j.length===0)return console.warn("No questions available"),[];const c=T([...j]),v=s||10,b=c.slice(0,Math.min(v,c.length));return console.log("Shuffled result:",b.length,"questions"),b},[t?.id,j.length,s]),n=o&&o.length>0?o[a]:null;m.useEffect(()=>{x(0),g(""),y(!1),L([]),w(r?.timeLimit||0)},[t?.id,s]);const A=m.useMemo(()=>n?.choices?T([...n.choices]):[],[a,n?.id]);m.useEffect(()=>(q.current=!1,g(""),y(!1),w(r?.timeLimit||0),l.current&&(clearInterval(l.current),l.current=null),r?.timeLimit>0&&(l.current=setInterval(()=>{w(c=>c<=0?(l.current&&(clearInterval(l.current),l.current=null),q.current||k(""),0):c-1)},1e3)),()=>{l.current&&(clearInterval(l.current),l.current=null)}),[a,r?.timeLimit]);const k=c=>{if(q.current)return;q.current=!0,y(!0),l.current&&(clearInterval(l.current),l.current=null);const v=c.trim().toLowerCase(),b=n.answer.trim().toLowerCase(),z=v===b;z?E.playCorrect():E.playIncorrect();const D={questionId:n.id,question:n.question,userAnswer:c,correctAnswer:n.answer,isCorrect:z,timeRemaining:S,maxTime:r?.timeLimit||0};L([...C,D]),r?.autoNext&&setTimeout(()=>{a<o.length-1?(g(""),y(!1),w(r?.timeLimit||0),x(Z=>Z+1)):$()},1500)},$=()=>{const c=C.filter(D=>D.isCorrect).length+(u===n.answer?1:0),v=o.length,b=[...C];u&&b.push({questionId:n.id,question:n.question,userAnswer:u,correctAnswer:n.answer,isCorrect:u===n.answer,timeRemaining:S,maxTime:r?.timeLimit||0});const z=W(r?.scoringMode||"basic",{correctAnswers:c,totalQuestions:v,answers:b});d({score:z,totalQuestions:v,correctAnswers:c,answers:b,questions:o}),E.playComplete(),i("result")};if(!t||!t.questions||t.questions.length===0)return console.log("QuizScreen: No lesson or questions",{hasCurrentLesson:!!t,hasQuestions:!!t?.questions,questionsLength:t?.questions?.length}),e.jsx(R,{className:"flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl text-gray-600 mb-4",children:"KhÃ´ng cÃ³ cÃ¢u há»i nÃ o!"}),e.jsx(I,{onClick:()=>i("lessonSelect"),variant:"primary",children:"Quay láº¡i chá»n mÃ´n"})]})});if(m.useEffect(()=>{console.log("QuizScreen Debug:",{hasCurrentLesson:!!t,questionsCount:j.length,shuffledCount:o?.length||0,questionCount:s,currentQuestionIndex:a,hasCurrentQuestion:!!n})},[t,j.length,o?.length,s,a,n]),!n||!o||o.length===0)return console.log("QuizScreen: No current question or shuffled questions",{hasCurrentQuestion:!!n,shuffledLength:o?.length||0,currentQuestionIndex:a,questionCount:s}),e.jsx(R,{className:"flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl text-gray-600 mb-4",children:"Äang táº£i cÃ¢u há»i..."}),e.jsx("p",{className:"text-sm text-gray-500",children:t?!o||o.length===0?"KhÃ´ng cÃ³ cÃ¢u há»i":"Äang xá»­ lÃ½...":"ChÆ°a chá»n mÃ´n há»c"}),e.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["Debug: shuffled=",o?.length||0,", idx=",a,", count=",s]}),e.jsx(I,{onClick:()=>i("lessonSelect"),variant:"outline",className:"mt-4",children:"Quay láº¡i"})]})});const G=u.trim().toLowerCase()===n.answer.trim().toLowerCase(),M=a===o.length-1;return e.jsxs(R,{maxWidth:"3xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(H,{currentIndex:a,totalQuestions:o.length,timeRemaining:S,timeLimit:r?.timeLimit||0}),e.jsxs("button",{type:"button",onClick:()=>f({autoNext:!r?.autoNext}),className:"ml-4 inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-3 py-1 text-xs text-gray-600 hover:border-primary-400 hover:text-primary-600 transition-colors",children:[e.jsx("span",{className:`inline-flex h-3 w-6 items-center rounded-full ${r?.autoNext?"bg-primary-500":"bg-gray-300"}`,children:e.jsx("span",{className:`h-3 w-3 transform rounded-full bg-white shadow transition-transform ${r?.autoNext?"translate-x-3":"translate-x-0"}`})}),e.jsx("span",{children:r?.autoNext?"Auto next":"Manual next"})]})]}),e.jsx(B,{mode:"wait",children:e.jsxs(J,{question:n.question,questionNumber:a+1,hint:n.hint,imageUrl:n.imageUrl,explanation:n.explanation,showExplanation:p,children:[n.type==="choice"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid gap-3",style:{gridTemplateColumns:`repeat(${Math.max(A.length||1,1)}, minmax(0, 1fr))`},children:A.map((c,v)=>{const b=u===c,z=c===n.answer;return e.jsx(V,{choice:c,isSelected:b,isCorrect:z,isAnswered:p,onClick:()=>!p&&g(c)},v)})}),!p&&e.jsx(I,{onClick:()=>u&&k(u),variant:"primary",size:"lg",className:"w-full",disabled:!u,children:"XÃ¡c nháº­n"})]}):e.jsx(Y,{value:u,onChange:g,onConfirm:()=>k(u),isAnswered:p,isCorrect:G,correctAnswer:n.answer}),p&&!r?.autoNext&&e.jsx(I,{onClick:()=>{M?$():(q.current=!1,g(""),y(!1),w(r?.timeLimit||0),x(c=>c+1))},variant:"outline",size:"lg",className:"w-full mt-2",children:M?"Xem káº¿t quáº£ ðŸŽ¯":"CÃ¢u tiáº¿p theo â†’"})]},a)})]})};export{le as QuizScreen};
//# sourceMappingURL=QuizScreen-BiN_Qmqo.js.map
